<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GÖZETİM ALTINDASIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=VT323&display=swap" rel="stylesheet">
    <style>
        /* --- Base Styles --- */
        body {
            font-family: 'VT323', monospace;
            background-color: #020202;
            color: #b0b0b0;
            overflow: hidden;
        }

        /* --- Overlay Effects --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        .scanline {
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.02) 50%, rgba(255, 255, 255, 0));
            animation: scan 7s linear infinite;
        }
        .vignette { box-shadow: inset 0 0 20vw rgba(0, 0, 0, 0.9); }
        .noise {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUEUgAAADIAAAAyCAMAAAAp4XiGAAAAA1BMVEX///+nxBvIAAAAIElEQVR42mP4BwYY/wEMgAL/gAL/gAL/gAL/gAL/gAL/gQL3BwDdNAb8k0qlGgAAAABJRU5ErkJggg==');
            animation: noise 0.15s steps(3) infinite;
        }

        /* --- Main Content --- */
        .content-wrapper {
            display: flex;
            flex-direction: column;
            /* FIX: Use svh for small viewport height to account for mobile browser UI */
            height: 100vh; /* Fallback */
            height: 100svh;
        }
        .content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding-top: 1rem;
            cursor: pointer;
            min-height: 0; /* Prevents flexbox overflow */
        }
        
        /* --- The Giant Eye --- */
        #surveillance-eye {
            width: 60vw;
            max-width: 300px;
            height: auto;
            color: #ff2a2a;
            filter: drop-shadow(0 0 10px #ff2a2a) drop-shadow(0 0 25px rgba(255, 42, 42, 0.5));
            animation: pulse 5s ease-in-out infinite;
        }
        #pupil {
            transition: transform 0.2s ease-out;
        }
        
        .subtitle {
            font-size: clamp(1.2rem, 4vw, 1.7rem);
            color: #888;
            margin-top: 1.5rem;
            letter-spacing: 0.2rem;
            animation: text-flicker 5s linear infinite;
        }
        .blinking-cursor {
            color: #00ff41;
            animation: blink 1s step-end infinite;
        }

        .command-hint {
            margin-top: 1rem;
            font-size: clamp(0.9rem, 2.4vw, 1.1rem);
            color: #00ff41;
            letter-spacing: 0.1rem;
            opacity: 0.8;
        }

        .audio-controls {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: center;
            color: #00ff41;
        }

        .top-controls {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 60;
            display: flex;
            gap: 0.5rem;
        }

        .history-panel {
            margin-top: 1rem;
            width: min(90vw, 450px);
            border: 1px solid rgba(0, 255, 65, 0.25);
            background: rgba(0, 255, 65, 0.04);
            padding: 0.5rem 0.75rem;
            color: #00ff41;
            font-size: 1rem;
            text-align: left;
        }

        .history-panel ul {
            list-style: none;
            margin: 0.3rem 0 0;
            padding: 0;
        }

        .control-button {
            border: 1px solid rgba(0, 255, 65, 0.35);
            background: rgba(0, 255, 65, 0.08);
            color: #00ff41;
            padding: 0.35rem 0.7rem;
            border-radius: 4px;
        }

        .volume-slider {
            accent-color: #00ff41;
            width: 120px;
        }

        .key:focus-visible,
        .panel-link:focus-visible,
        .control-button:focus-visible,
        .volume-slider:focus-visible,
        #main-content:focus-visible,
        .panel:focus-visible {
            outline: 2px solid #00ff41;
            outline-offset: 2px;
        }

        /* --- Custom Keyboard --- */
        #keyboard {
            z-index: 50;
            flex-shrink: 0;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            opacity: 0;
        }
        #keyboard.visible {
            transform: translateY(0);
            opacity: 1;
        }
        .key {
            font-family: 'VT323', monospace;
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid rgba(0, 255, 65, 0.2);
            color: rgba(0, 255, 65, 0.7);
            border-radius: 4px;
            text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
            transition: background 0.1s, color 0.1s;
        }
        .key:active {
            background: rgba(0, 255, 65, 0.2);
            color: #fff;
        }
        .key.special {
            flex-grow: 1;
        }

        /* --- Hidden Panels (Puzzle Sections) --- */
        .panel {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            flex-direction: column;
            width: 100%;
            cursor: pointer;
            min-height: 0; /* Prevents flexbox overflow */
        }
        .panel-content {
            border: 1px solid #ff4747;
            padding: 1rem 2rem;
            width: 100%;
            max-width: 800px;
            color: #ff4747;
            text-shadow: 0 0 3px #ff4747;
            overflow-y: auto; /* Allow scrolling within panel if needed */
        }
        .panel-content h2 { font-size: 2rem; margin-bottom: 1rem; text-align: center; }
        .panel-content p, .panel-content a { font-size: 1.25rem; line-height: 1.7; }
        .redacted { background-color: #ff4747; color: #ff4747; user-select: none; }
        .panel-link { display: block; text-align: center; margin-top: 2rem; border: 1px solid #ff4747; padding: 0.5rem 1rem; text-decoration: none; color: #ff4747; transition: background-color 0.2s, color 0.2s; }
        .panel-link:hover { background-color: #ff4747; color: #020202; cursor: crosshair; }
        .exit-prompt { margin-top: 1rem; text-align: center; font-size: 1rem; color: #888; animation: text-flicker 7s linear infinite; }

        /* --- Glitch Effects --- */
        #glitch-container { position: fixed; inset: 0; overflow: hidden; pointer-events: none; z-index: 50; }
        .glitch-text { position: absolute; color: #00ff41; font-size: 1.5rem; opacity: 0; text-shadow: 0 0 5px #00ff41; white-space: nowrap; }

        /* --- Animations --- */
        @keyframes scan { 0% { background-position: 0 0; } 100% { background-position: 0 100vh; } }
        @keyframes noise { 0%, 100% { background-position: 0 0; } 10% { background-position: -5% -10%; } 20% { background-position: -15% 5%; } 30% { background-position: 7% -25%; } 40% { background-position: 20% 25%; } 50% { background-position: -25% 10%; } 60% { background-position: 15% 5%; } 70% { background-position: 0% 15%; } 80% { background-position: 25% 35%; } 90% { background-position: -10% 10%; } }
        @keyframes text-flicker { 0% { opacity: 0.8; } 2% { opacity: 1; } 8% { opacity: 0.5; } 9% { opacity: 1; } 12% { opacity: 0.9; } 20% { opacity: 1; } 25% { opacity: 0.6; } 30% { opacity: 1; } 70% { opacity: 1; } 72% { opacity: 0.7; } 77% { opacity: 1; } 100% { opacity: 1; } }
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes pulse { 0% { transform: scale(1); filter: drop-shadow(0 0 10px #ff2a2a) drop-shadow(0 0 25px rgba(255, 42, 42, 0.5)); } 50% { transform: scale(1.02); filter: drop-shadow(0 0 15px #ff2a2a) drop-shadow(0 0 40px rgba(255, 42, 42, 0.7)); } 100% { transform: scale(1); filter: drop-shadow(0 0 10px #ff2a2a) drop-shadow(0 0 25px rgba(255, 42, 42, 0.5)); } }
    
        /* FIX: Media query for short screens (landscape mobile) */
        @media (max-height: 600px) {
            #surveillance-eye {
                max-width: 150px;
            }
            .key {
                font-size: 1rem;
                padding: 0.4rem 0.6rem;
            }
        }
    </style>
</head>
<body>

    <div class="overlay noise"></div>
    <div class="overlay scanline"></div>
    <div class="overlay vignette"></div>
    <div id="glitch-container"></div>
    <div class="top-controls" role="group" aria-label="Global controls">
        <button id="language-toggle" class="control-button" type="button">DİL: TR</button>
    </div>

    <div class="content-wrapper">
        <main id="main-content" class="content" tabindex="0" aria-label="Ana terminal ekranı">
            <svg id="surveillance-eye" viewBox="0 0 24 24" fill="currentColor">
                <g id="pupil">
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zm0 13c-4.41 0-8-2.69-9.72-6.5C3.96 7.61 7.59 5 12 5s8.04 2.61 9.72 6.5C20 14.81 16.41 17.5 12 17.5zm0-10.5c-2.48 0-4.5 2.02-4.5 4.5s2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5-2.02-4.5-4.5-4.5z"/>
                </g>
            </svg>
            <div class="subtitle">
                <span>> </span><span id="typed-text"></span><span class="blinking-cursor">_</span>
            </div>
            <p class="command-hint" aria-live="polite">KOMUT İPUCU: YARDIM, BILGI, BILET, IZIN, CIKIS</p>
            <div class="audio-controls" role="group" aria-label="Ses kontrolleri">
                <button id="mute-toggle" class="control-button" type="button" aria-pressed="false">SESSİZ: KAPALI</button>
                <label for="volume-control">SES</label>
                <input id="volume-control" class="volume-slider" type="range" min="0" max="100" value="10" aria-label="Ses seviyesi">
            </div>
            <div class="history-panel" aria-live="polite">
                <strong id="history-title">SON KOMUTLAR</strong>
                <ul id="history-list"></ul>
            </div>
        </main>

        <div id="info-panel" class="panel hidden" tabindex="0" aria-label="Bilgi paneli">
            <div class="panel-content">
                <h2>[ DOSYA_734 ERİŞİM SAĞLANDI ]</h2>
                <p>PROJE: Locus Mirabilis. AMAÇ: Toplumsal uyum ve istikrarın sağlanması. MEVCUT DURUM: Faz 3 aktif. Vatandaşların katılımı zorunludur. YER: <span class="redacted">████████████ Tiyatrosu</span>. TARİH: <span class="redacted">HER GÜN</span>. SAAT: <span class="redacted">20:00</span>. Gerçeklik yeniden tanımlanacak. Sorgulama.</p>
                <p class="exit-prompt">> Çıkmak için 'CIKIS' yazın veya ESC tuşuna basın.</p>
            </div>
        </div>
        <div id="ticket-panel" class="panel hidden" tabindex="0" aria-label="Erişim izni paneli">
            <div class="panel-content">
                <h2>[ ERİŞİM İZNİ_217 ]</h2>
                <p id="ticket-description">Vatandaş katılımı, rejimin devamlılığı için esastır. Kaydınız, sisteme olan sadakatinizin bir göstergesidir. İzinsiz varlıklar tespit edilecek ve arındırılacaktır. Katılımınızı onaylayarak, Locus Mirabilis'in kurallarını ve gerçekliğini kabul etmiş olursunuz.</p>
                <form id="registration-form" class="mt-6 space-y-3" novalidate>
                    <label class="block">
                        <span id="reg-name-label">KOD ADI</span>
                        <input id="reg-name" class="w-full p-2 bg-black/30 border border-red-400" type="text" required maxlength="32" autocomplete="off">
                    </label>
                    <label class="block">
                        <span id="reg-contact-label">İLETİŞİM KANALI</span>
                        <input id="reg-contact" class="w-full p-2 bg-black/30 border border-red-400" type="email" required maxlength="80" autocomplete="off">
                    </label>
                    <button class="panel-link mt-0" type="submit" id="registration-submit">[ KAYDI TAMAMLA ]</button>
                    <p id="registration-status" class="text-center min-h-[2rem]"></p>
                </form>
                <p class="exit-prompt">> Çıkmak için 'CIKIS' yazın veya ESC tuşuna basın.</p>
            </div>
        </div>

        <div id="keyboard" class="p-1 md:p-2 flex flex-col gap-1 md:gap-2" role="group" aria-label="Ekran klavyesi" aria-hidden="true">
            <div class="flex justify-center gap-1 md:gap-2">
                <button class="key p-2 text-lg md:p-3 md:text-xl">E</button> <button class="key p-2 text-lg md:p-3 md:text-xl">R</button> <button class="key p-2 text-lg md:p-3 md:text-xl">T</button> <button class="key p-2 text-lg md:p-3 md:text-xl">Y</button> <button class="key p-2 text-lg md:p-3 md:text-xl">U</button> <button class="key p-2 text-lg md:p-3 md:text-xl">I</button> <button class="key p-2 text-lg md:p-3 md:text-xl">O</button> <button class="key p-2 text-lg md:p-3 md:text-xl">P</button> <button class="key p-2 text-lg md:p-3 md:text-xl">Ğ</button> <button class="key p-2 text-lg md:p-3 md:text-xl">Ü</button>
            </div>
            <div class="flex justify-center gap-1 md:gap-2">
                <button class="key p-2 text-lg md:p-3 md:text-xl">A</button> <button class="key p-2 text-lg md:p-3 md:text-xl">S</button> <button class="key p-2 text-lg md:p-3 md:text-xl">D</button> <button class="key p-2 text-lg md:p-3 md:text-xl">F</button> <button class="key p-2 text-lg md:p-3 md:text-xl">G</button> <button class="key p-2 text-lg md:p-3 md:text-xl">H</button> <button class="key p-2 text-lg md:p-3 md:text-xl">J</button> <button class="key p-2 text-lg md:p-3 md:text-xl">K</button> <button class="key p-2 text-lg md:p-3 md:text-xl">L</button> <button class="key p-2 text-lg md:p-3 md:text-xl">Ş</button> <button class="key p-2 text-lg md:p-3 md:text-xl">İ</button>
            </div>
            <div class="flex justify-center gap-1 md:gap-2">
                <button class="key p-2 text-lg md:p-3 md:text-xl">Z</button> <button class="key p-2 text-lg md:p-3 md:text-xl">C</button> <button class="key p-2 text-lg md:p-3 md:text-xl">V</button> <button class="key p-2 text-lg md:p-3 md:text-xl">B</button> <button class="key p-2 text-lg md:p-3 md:text-xl">N</button> <button class="key p-2 text-lg md:p-3 md:text-xl">M</button> <button class="key p-2 text-lg md:p-3 md:text-xl">Ö</button> <button class="key p-2 text-lg md:p-3 md:text-xl">Ç</button>
            </div>
            <div class="flex justify-center gap-1 md:gap-2">
                 <button class="key special p-2 text-lg md:p-3 md:text-xl" data-key="ESC">ESC</button>
                 <button class="key special p-2 text-lg md:p-3 md:text-xl" data-key="SİL">SİL</button>
                 <button class="key special p-2 text-lg md:p-3 md:text-xl" data-key="GİR">GİR</button>
            </div>
        </div>
    </div>
    
    <audio id="ambient-sound" loop preload="auto" src="https://freesound.org/data/previews/516/516377_10734399-lq.mp3"></audio>
    <audio id="typing-sound" preload="auto" src="https://freesound.org/data/previews/254/254323_4243528-lq.mp3"></audio>
    <audio id="error-sound" preload="auto" src="https://freesound.org/data/previews/142/142608_1843196-lq.mp3"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const typedTextEl = document.getElementById('typed-text');
            const glitchContainer = document.getElementById('glitch-container');
            const mainContent = document.getElementById('main-content');
            const infoPanel = document.getElementById('info-panel');
            const ticketPanel = document.getElementById('ticket-panel');
            const pupil = document.getElementById('pupil');
            const keyboard = document.getElementById('keyboard');
            const keyboardKeys = keyboard.querySelectorAll('.key');
            const muteToggle = document.getElementById('mute-toggle');
            const volumeControl = document.getElementById('volume-control');
            const languageToggle = document.getElementById('language-toggle');
            const commandHintEl = document.querySelector('.command-hint');
            const historyTitle = document.getElementById('history-title');
            const historyList = document.getElementById('history-list');
            const registrationForm = document.getElementById('registration-form');
            const registrationStatus = document.getElementById('registration-status');
            const regNameLabel = document.getElementById('reg-name-label');
            const regContactLabel = document.getElementById('reg-contact-label');
            const registrationSubmit = document.getElementById('registration-submit');
            const ticketDescription = document.getElementById('ticket-description');
            
            const ambientSound = document.getElementById('ambient-sound');
            const typingSound = document.getElementById('typing-sound');
            const errorSound = document.getElementById('error-sound');

            let userInput = '';
            let audioUnlocked = false;
            let isMuted = false;
            let masterVolume = Number(volumeControl.value) / 100;
            let language = 'TR';
            let lastOpenedPanel = 'main';
            let commandHistory = [];
            let puzzleState = { dossierSeen: false, clueUnlocked: false, branch: 'none' };
            const MAX_COMMAND_LENGTH = 20;
            const HELP_COMMANDS = ['YARDIM', 'BILGI', 'BILET', 'IZIN', 'CIKIS'];
            const glitchPhrases = ['SENİ DUYUYORLAR', 'İTAAT ET', 'SORGU SUAL YOK', 'GERÇEK NEDİR?', 'BÜYÜK BİRADER İZLİYOR', 'DÜŞÜNCE BİR SUÇTUR', 'SİSTEME GÜVEN', 'YALNIZ DEĞİLSİN'];
            const SESSION_KEY = 'locusMirabilisSession';
            const i18n = {
                TR: {
                    languageButton: 'DİL: TR',
                    hint: 'KOMUT İPUCU: YARDIM, BILGI, BILET, IZIN, CIKIS',
                    historyTitle: 'SON KOMUTLAR',
                    emptyHistory: 'Henüz komut girilmedi.',
                    ticketDescription: "Vatandaş katılımı, rejimin devamlılığı için esastır. Kaydınız, sisteme olan sadakatinizin bir göstergesidir. İzinsiz varlıklar tespit edilecek ve arındırılacaktır. Katılımınızı onaylayarak, Locus Mirabilis'in kurallarını ve gerçekliğini kabul etmiş olursunuz.",
                    regName: 'KOD ADI',
                    regContact: 'İLETİŞİM KANALI',
                    regSubmit: '[ KAYDI TAMAMLA ]',
                    regSuccess: 'Kayıt alındı. Sistem sizi izliyor.',
                    regError: 'Geçerli ad ve iletişim kanalı girin.',
                    helpPrefix: 'MEVCUT KOMUTLAR:'
                },
                EN: {
                    languageButton: 'LANG: EN',
                    hint: 'COMMAND HINT: HELP, INFO, TICKET, ACCESS, EXIT',
                    historyTitle: 'RECENT COMMANDS',
                    emptyHistory: 'No commands yet.',
                    ticketDescription: 'Citizen participation is essential for regime continuity. Your registration proves your loyalty to the system. Unauthorized entities will be detected and purified. By confirming participation, you accept the rules and reality of Locus Mirabilis.',
                    regName: 'CODE NAME',
                    regContact: 'CONTACT CHANNEL',
                    regSubmit: '[ COMPLETE REGISTRATION ]',
                    regSuccess: 'Registration captured. The system is watching you.',
                    regError: 'Provide a valid name and contact channel.',
                    helpPrefix: 'AVAILABLE COMMANDS:'
                }
            };

            function normalizeCommand(value) {
                const base = value
                    .trim()
                    .toLocaleUpperCase('tr-TR')
                    .replace(/İ/g, 'I')
                    .replace(/Ş/g, 'S')
                    .replace(/Ğ/g, 'G')
                    .replace(/Ü/g, 'U')
                    .replace(/Ö/g, 'O')
                    .replace(/Ç/g, 'C');

                const aliases = {
                    HELP: 'YARDIM',
                    INFO: 'BILGI',
                    TICKET: 'BILET',
                    ACCESS: 'IZIN',
                    EXIT: 'CIKIS',
                    TRACE: 'IZ'
                };
                return aliases[base] || base;
            }

            function safePlay(audioEl, startFromZero = false) {
                if (!audioUnlocked || !audioEl) return;
                if (startFromZero) {
                    audioEl.currentTime = 0;
                }
                audioEl.play().catch(() => {});
            }

            function getLocaleText(key) {
                return i18n[language][key];
            }

            function saveSessionState() {
                const payload = {
                    language,
                    lastOpenedPanel,
                    commandHistory,
                    puzzleState
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(payload));
            }

            function loadSessionState() {
                try {
                    const raw = localStorage.getItem(SESSION_KEY);
                    if (!raw) return;
                    const parsed = JSON.parse(raw);
                    language = parsed.language === 'EN' ? 'EN' : 'TR';
                    lastOpenedPanel = parsed.lastOpenedPanel || 'main';
                    commandHistory = Array.isArray(parsed.commandHistory) ? parsed.commandHistory.slice(0, 6) : [];
                    puzzleState = {
                        dossierSeen: Boolean(parsed.puzzleState?.dossierSeen),
                        clueUnlocked: Boolean(parsed.puzzleState?.clueUnlocked),
                        branch: ['none', 'trust', 'resist'].includes(parsed.puzzleState?.branch) ? parsed.puzzleState.branch : 'none'
                    };
                } catch {
                    localStorage.removeItem(SESSION_KEY);
                }
            }

            function renderHistory() {
                historyList.innerHTML = '';
                if (!commandHistory.length) {
                    const li = document.createElement('li');
                    li.textContent = getLocaleText('emptyHistory');
                    historyList.appendChild(li);
                    return;
                }
                commandHistory.slice().reverse().forEach((command) => {
                    const li = document.createElement('li');
                    li.textContent = `> ${command}`;
                    historyList.appendChild(li);
                });
            }

            function renderLanguage() {
                languageToggle.textContent = getLocaleText('languageButton');
                commandHintEl.textContent = getLocaleText('hint');
                historyTitle.textContent = getLocaleText('historyTitle');
                ticketDescription.textContent = getLocaleText('ticketDescription');
                regNameLabel.textContent = getLocaleText('regName');
                regContactLabel.textContent = getLocaleText('regContact');
                registrationSubmit.textContent = getLocaleText('regSubmit');
                registrationStatus.textContent = '';
                renderHistory();
            }

            function pushCommandToHistory(command) {
                commandHistory.push(command);
                if (commandHistory.length > 6) {
                    commandHistory.shift();
                }
                renderHistory();
            }

            function isVisiblePanelOpen() {
                return !infoPanel.classList.contains('hidden') || !ticketPanel.classList.contains('hidden');
            }

            function applyAudioSettings() {
                const effectVolume = Math.min(1, masterVolume * 2.5);
                [ambientSound, typingSound, errorSound].forEach((audioEl) => {
                    audioEl.muted = isMuted;
                });
                ambientSound.volume = masterVolume;
                typingSound.volume = effectVolume;
                errorSound.volume = effectVolume;
            }

            function updateMuteButtonText() {
                muteToggle.textContent = `SESSİZ: ${isMuted ? 'AÇIK' : 'KAPALI'}`;
                muteToggle.setAttribute('aria-pressed', String(isMuted));
            }

            function setKeyboardVisibility(isVisible) {
                keyboard.classList.toggle('visible', isVisible);
                keyboard.setAttribute('aria-hidden', String(!isVisible));
                keyboardKeys.forEach((keyEl) => {
                    keyEl.tabIndex = isVisible ? 0 : -1;
                    keyEl.setAttribute('type', 'button');
                    if (!keyEl.hasAttribute('aria-label')) {
                        const keyText = (keyEl.dataset.key || keyEl.textContent || '').trim();
                        const labels = { ESC: 'Çıkış', 'SİL': 'Sil', 'GİR': 'Komutu çalıştır' };
                        keyEl.setAttribute('aria-label', labels[keyText] || `${keyText} tuşu`);
                    }
                });
            }

            function startExperience() {
                if (audioUnlocked) return;
                
                ambientSound.play().then(() => {
                    applyAudioSettings();
                }).catch(e => console.error("Ambient sound failed:", e));

                typingSound.play().then(() => typingSound.pause()).catch(e => {});
                errorSound.play().then(() => errorSound.pause()).catch(e => {});

                audioUnlocked = true;
                document.removeEventListener('click', startExperience);
                document.removeEventListener('keydown', startExperience);
            }
            document.addEventListener('click', startExperience);
            document.addEventListener('keydown', startExperience);
            loadSessionState();
            setKeyboardVisibility(false);
            applyAudioSettings();
            updateMuteButtonText();
            renderLanguage();

            if (lastOpenedPanel === 'info') {
                showPanel(infoPanel);
            } else if (lastOpenedPanel === 'ticket') {
                showPanel(ticketPanel);
            }

            function handleInput(key) {
                if (key === 'GİR') {
                    if (userInput.trim()) {
                        processCommand(userInput);
                    }
                    userInput = '';
                } else if (key === 'SİL') {
                    userInput = userInput.slice(0, -1);
                } else if (/^[a-zA-ZçğıöşüÇĞİÖŞÜ]$/.test(key) && userInput.length < MAX_COMMAND_LENGTH) {
                    userInput += key.toLocaleUpperCase('tr-TR');
                    safePlay(typingSound, true);
                }
                typedTextEl.textContent = userInput;
                if (Math.random() < 0.2) createGlitch();
            }

            function triggerEscape() {
                if (!infoPanel.classList.contains('hidden') || !ticketPanel.classList.contains('hidden')) {
                    hideAllPanels();
                    userInput = '';
                    typedTextEl.textContent = userInput;
                }
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    triggerEscape();
                    return; 
                }
                if (e.key === 'Enter') handleInput('GİR');
                else if (e.key === 'Backspace') handleInput('SİL');
                else if (e.key.length === 1) handleInput(e.key);
            });

            keyboard.addEventListener('click', (e) => {
                if (e.target.matches('.key')) {
                    const key = e.target.dataset.key || e.target.textContent;
                    if (key === 'ESC') {
                        triggerEscape();
                        return;
                    }
                    handleInput(key);
                }
            });
            
            mainContent.addEventListener('click', () => {
                setKeyboardVisibility(true);
            });
            
            infoPanel.addEventListener('click', () => {
                setKeyboardVisibility(true);
            });
            ticketPanel.addEventListener('click', () => {
                setKeyboardVisibility(true);
            });

            muteToggle.addEventListener('click', () => {
                isMuted = !isMuted;
                updateMuteButtonText();
                applyAudioSettings();
            });

            languageToggle.addEventListener('click', () => {
                language = language === 'TR' ? 'EN' : 'TR';
                renderLanguage();
                saveSessionState();
            });

            registrationForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const nameField = document.getElementById('reg-name');
                const contactField = document.getElementById('reg-contact');
                const nameValue = nameField.value.trim();
                const contactValue = contactField.value.trim();
                if (!nameValue || !contactField.checkValidity()) {
                    registrationStatus.textContent = getLocaleText('regError');
                    safePlay(errorSound, true);
                    return;
                }
                registrationStatus.textContent = getLocaleText('regSuccess');
                createGlitch(language === 'TR' ? `KAYIT: ${nameValue}` : `REGISTERED: ${nameValue}`);
                nameField.value = '';
                contactField.value = '';
            });

            volumeControl.addEventListener('input', (event) => {
                masterVolume = Number(event.target.value) / 100;
                applyAudioSettings();
            });

            document.addEventListener('mousemove', (e) => {
                const x = (e.clientX / window.innerWidth - 0.5) * 2;
                const y = (e.clientY / window.innerHeight - 0.5) * 2;
                const maxOffset = 1.5;
                pupil.style.transform = `translate(${x * maxOffset}px, ${y * maxOffset}px)`;
            });

            function processCommand(command) {
                const normalizedCommand = normalizeCommand(command);
                pushCommandToHistory(normalizedCommand);

                switch (normalizedCommand) {
                    case 'YARDIM':
                        displayHelp();
                        break;
                    case 'BILGI':
                        puzzleState.dossierSeen = true;
                        showPanel(infoPanel);
                        break;
                    case 'BILET':
                    case 'IZIN':
                        showPanel(ticketPanel);
                        break;
                    case 'IZ':
                        if (puzzleState.dossierSeen) {
                            puzzleState.clueUnlocked = true;
                            createGlitch(language === 'TR' ? 'İPUCU: TRUST veya RESIST' : 'CLUE: TRUST or RESIST');
                        }
                        break;
                    case 'TRUST':
                        if (puzzleState.clueUnlocked) {
                            puzzleState.branch = 'trust';
                            createGlitch(language === 'TR' ? 'SİSTEM SENİ ONAYLADI' : 'SYSTEM APPROVES YOU');
                        }
                        break;
                    case 'RESIST':
                        if (puzzleState.clueUnlocked) {
                            puzzleState.branch = 'resist';
                            createGlitch(language === 'TR' ? 'DİRENİŞ KAYDEDİLDİ' : 'RESISTANCE REGISTERED');
                        }
                        break;
                    case 'CIKIS':
                        hideAllPanels();
                        break;
                    default:
                        if (!isVisiblePanelOpen()) {
                            safePlay(errorSound, true);
                            createGlitch('GEÇERSİZ KOMUT');
                        }
                        break;
                }
                saveSessionState();
            }

            function displayHelp() {
                const commandSet = language === 'TR'
                    ? HELP_COMMANDS.join(', ') + ', IZ'
                    : 'HELP, INFO, TICKET, ACCESS, EXIT, TRACE';
                const helpText = `${getLocaleText('helpPrefix')} ${commandSet}`;
                let i = 0;
                userInput = '';
                typedTextEl.textContent = '';
                const interval = setInterval(() => {
                    if(i < helpText.length) {
                        typedTextEl.textContent += helpText[i];
                        i++;
                    } else {
                        clearInterval(interval);
                        setTimeout(() => { typedTextEl.textContent = ''; }, 2000);
                    }
                }, 50);
            }

            function showPanel(panel) {
                mainContent.classList.add('hidden');
                setKeyboardVisibility(false);
                panel.classList.remove('hidden');
                panel.focus();
                lastOpenedPanel = panel === infoPanel ? 'info' : 'ticket';
                saveSessionState();
            }

            function hideAllPanels() {
                mainContent.classList.remove('hidden');
                setKeyboardVisibility(false);
                infoPanel.classList.add('hidden');
                ticketPanel.classList.add('hidden');
                mainContent.focus();
                lastOpenedPanel = 'main';
                saveSessionState();
            }

            function createGlitch(text) {
                const glitch = document.createElement('div');
                glitch.className = 'glitch-text';
                glitch.textContent = text || glitchPhrases[Math.floor(Math.random() * glitchPhrases.length)];
                glitch.style.top = `${Math.random() * 100}vh`;
                glitch.style.left = `${Math.random() * 100}vw`;
                
                glitchContainer.appendChild(glitch);

                setTimeout(() => { glitch.style.opacity = 1; }, 50);
                setTimeout(() => { glitch.style.opacity = 0; }, 200 + Math.random() * 300);
                setTimeout(() => { if (glitch.parentNode === glitchContainer) glitchContainer.removeChild(glitch); }, 1000);
            }
        });
    </script>

</body>
</html>
